<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿杰智能下载中心</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://npm.elemecdn.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0ea5e9',
            success: '#10b981',
            danger: '#ef4444',
            dark: '#1e293b',
            glow: '#06b6d4',
          },
          fontFamily: {
            cyber: ['monospace', 'Consolas', '"Courier New"', 'monospace'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow-glow {
        text-shadow: 0 0 8px theme('colors.glow'), 0 0 16px theme('colors.glow/70');
      }
      .bg-grid {
        background-image: linear-gradient(rgba(14, 165, 233, 0.1) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(14, 165, 233, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
      }
      .animate-slide-down {
        animation: slideDown 0.8s ease forwards;
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .backdrop-blur-sm {
        backdrop-filter: blur(4px);
      }
      /* 整合开始.html的授权提示样式 */
      .auth-bg {
        background-color: #0a1929;
        background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                          linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
        background-size: 20px 20px;
      }
      .auth-tip-box {
        width: 100%;
        background-color: #e60012;
        padding: 80px 0;
        text-align: center;
        transition: transform 0.8s ease-in-out;
      }
      .auth-tip-success {
        background-color: #10b981 !important;
        transition: transform 0.8s ease-in-out;
      }
      .auth-tip-text {
        font-size: 80px;
        color: #ffffff;
        font-weight: bold;
        font-family: "Microsoft Yahei", sans-serif;
        letter-spacing: 2px;
      }
      
      /* 最佳线路高亮 */
      .best-line {
        animation: highlightPulse 1s ease-in-out;
        background-color: rgba(16, 185, 129, 0.3) !important; /* 绿色半透明背景 */
      }
      
      @keyframes highlightPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      /* 终端输出样式 */
      #terminalOutput {
        max-height: 200px;
        overflow-y: auto;
      }
      
      .terminal-line {
        margin-bottom: 0.25rem;
        opacity: 0;
        animation: fadeInUp 0.3s forwards;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* 下载按钮美化 */
      .download-container {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .download-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.4rem 1.6rem;
        background-color: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(16, 185, 129, 0.3);
        color: #10b981;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
        text-decoration: none;
        position: relative;
        overflow: hidden;
        min-width: 60px;
      }
      
      .download-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.2), transparent);
        transition: 0.5s;
      }
      
      .download-btn:hover {
        background-color: rgba(16, 185, 129, 0.2);
        color: #06b6d4;
        border-color: rgba(6, 182, 212, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        z-index: 10;
      }
      
      .download-btn:hover::before {
        left: 100%;
      }
      
      .download-btn i {
        margin-right: 0.25rem;
      }
      
      .best-download-btn {
        background-color: rgba(16, 185, 129, 0.5) !important; /* 绿色背景 */
        border: 1px solid rgba(16, 185, 129, 0.8) !important;
        color: #ffffff !important;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      }
      
      .recommend-badge {
        background-color: #10b981;
        color: white;
        font-size: 0.6rem;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        vertical-align: middle;
      }
      @media (max-width: 768px) {
        .auth-tip-text {
          font-size: 28px;
        }
      }
    }
    @keyframes slideDown {
      0% { transform: translateY(-100%); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
  </style>

</head>
<body class="bg-dark text-white min-h-screen overflow-x-hidden bg-grid">

  <!-- 替换后的授权状态容器（整合开始.html结构） -->
  <div id="authContainer" class="fixed inset-0 z-50 auth-bg flex items-center justify-center transition-all duration-700">
    <div class="w-full h-full flex items-center justify-center">
      <div id="authTipBox" class="auth-tip-box">
        <div id="authTipText" class="auth-tip-text">文件未授权请联系阿杰</div>
      </div>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="mainInterface" class="hidden opacity-0 transition-opacity duration-1000 pt-8 px-12">
    <!-- 顶部测速区域和终端日志 -->
    <div class="mb-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧测速区域 -->
      <div class="lg:col-span-1 p-6 bg-dark/50 backdrop-blur-sm rounded-lg border border-primary/30 shadow-lg">
        <h2 class="text-2xl font-cyber mb-4 text-primary text-shadow-glow">
          <i class="fa fa-tachometer mr-2"></i>实时网络测速
        </h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-3 bg-dark/80 rounded border border-success/20">
            <div class="text-xs text-gray-400">电信线路</div>
            <div id="telcomSpeed" class="font-cyber text-success truncate">--</div>
          </div>
          <div class="p-3 bg-dark/80 rounded border border-success/20">
            <div class="text-xs text-gray-400">联通线路</div>
            <div id="unicomSpeed" class="font-cyber text-success truncate">--</div>
          </div>
          <div class="p-3 bg-dark/80 rounded border border-success/20">
            <div class="text-xs text-gray-400">移动线路</div>
            <div id="cmnetSpeed" class="font-cyber text-success truncate">--</div>
          </div>
          <div class="p-3 bg-dark/80 rounded border border-success/20">
            <div class="text-xs text-gray-400">北美线路</div>
            <div id="uswSpeed" class="font-cyber text-success truncate">--</div>
          </div>
        </div>
        <div class="mt-4 p-3 bg-dark/80 rounded border border-primary/30">
          <div class="text-sm text-gray-400">推荐线路</div>
          <div id="avgSpeed" class="text-2xl font-cyber text-primary text-shadow-glow">--</div>
        </div>
      </div>
      
      <!-- 右侧终端日志 -->
      <div class="lg:col-span-2 p-6 bg-black/80 backdrop-blur-sm rounded-lg border border-green-500/30 shadow-lg flex flex-col">
        <div class="flex items-center mb-4">
          <i class="fa fa-terminal text-green-500 mr-2"></i>
          <h2 class="text-2xl font-cyber text-green-500 text-shadow-glow">系统日志</h2>
        </div>
        <div id="terminalOutput" class="flex-grow bg-gray-900 rounded p-3 overflow-y-auto font-mono text-sm text-green-400 whitespace-pre-wrap">
          <div class="terminal-line">> 系统启动...</div>
          <div class="terminal-line">> 初始化网络模块...</div>
          <div class="terminal-line">> 网络模块加载完成</div>
          <div class="terminal-line">> 准备就绪...</div>
        </div>
        <div class="mt-2 flex">
          <span class="text-green-500 font-cyber">&gt;</span>
          <span class="ml-2 animate-pulse text-green-500">|</span>
        </div>
      </div>
    </div>

    <!-- 下载列表区域 -->
    <div class="p-6 bg-dark/50 backdrop-blur-sm rounded-lg border border-primary/30 shadow-lg">
      <h2 class="text-2xl font-cyber mb-4 text-primary text-shadow-glow">
        <i class="fa fa-download mr-2"></i>软件下载列表
      </h2>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="border-b border-primary/30">
              <th class="text-left p-3 font-cyber text-primary w-2/3">软件名称</th>
              <th class="text-center p-3 font-cyber text-primary w-1/3">下载链接</th>
            </tr>
          </thead>
          <tbody id="downloadTableBody">
            <!-- 下载项动态生成 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 全局状态
    let currentSoftwareList = [];
    const JSON_URL = 'http://cdn.hlcssc.com/rjdz.json';
    const CHECK_INTERVAL = 10000; // 10秒检查一次
    const EXPIRE_DURATION = 86400000; // 24小时有效期 (24 * 60 * 60 * 1000)
    
    // 本地存储授权检查时间，用于备用机制
    const AUTH_CHECK_KEY = 'lastAuthCheck';
    const LOCAL_AUTH_DURATION = 86400000; // 本地记录的有效期也是24小时

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 接收 Python 侧回传的状态/进度（pywebview -> JS）
      window.__pyDownloadStatus = function(payload) {
        try {
          if (payload && payload.message) {
            addToTerminal(payload.message);
          }
        } catch (e) {
          // ignore
        }
      };

      window.__pyDownloadProgress = function(payload) {
        try {
          if (!payload) return;
          const name = payload.filename || '';
          const downloaded = payload.downloaded || 0;
          const total = payload.total || 0;
          const percent = payload.percent;
          if (percent !== null && percent !== undefined && total > 0) {
            addToTerminal(`下载进度: ${name} ${percent}% (${downloaded}/${total})`);
          } else {
            addToTerminal(`下载进度: ${name} ${downloaded} bytes`);
          }
        } catch (e) {
          // ignore
        }
      };

      // 拦截下载按钮：在桌面端用 Python 执行下载；非桌面端则继续走浏览器默认下载
      document.body.addEventListener('click', async (e) => {
        const a = e.target && e.target.closest ? e.target.closest('a.download-btn') : null;
        if (!a) return;

        const url = a.getAttribute('href');
        if (!url) return;

        const fileCell = a.closest('tr')?.querySelector('td');
        const softwareName = fileCell ? fileCell.textContent.trim() : '';
        const filename = softwareName ? `${softwareName}.rar` : null;

        const api = window.pywebview && window.pywebview.api;
        if (!api || typeof api.start_download !== 'function') {
          return;
        }

        e.preventDefault();

        try {
          addToTerminal(`准备下载: ${softwareName || url}`);
          const res = await api.start_download(url, filename);
          if (res && res.ok) {
            addToTerminal(`下载任务已创建: ${res.path}`);
          } else {
            addToTerminal(`下载启动失败: ${(res && res.error) ? res.error : 'unknown error'}`);
          }
        } catch (err) {
          addToTerminal(`下载启动异常: ${err && err.message ? err.message : err}`);
        }
      });

      // 立即检查授权并加载数据
      checkAuthAndLoadData();
      // 然后设置定期检查
      setInterval(checkAuthAndLoadData, CHECK_INTERVAL);
      
      // 额外确保即使在某些情况下DOM已加载后也能触发检查
      setTimeout(checkAuthAndLoadData, 2000); // 2秒后再次检查，以防首次检查时网络较慢
    });
    
    // 页面可见性变化时也检查授权状态
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        // 页面重新可见时检查授权状态
        setTimeout(checkAuthAndLoadData, 1000);
      }
    });

    // 检查授权并加载数据
    async function checkAuthAndLoadData() {
      try {
        console.log('开始检查授权...');
        addToTerminal('正在检查授权状态...');
        
        // 添加时间戳参数防止缓存
        const timestamp = new Date().getTime();
        const urlWithTimestamp = `${JSON_URL}?t=${timestamp}`;
        const response = await fetch(urlWithTimestamp, {
          cache: 'no-cache', // 防止缓存
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        
        // 检查响应状态
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const jsonData = await response.json();
        console.log('获取到JSON数据:', jsonData);
        addToTerminal('JSON数据获取成功');
        
        // 检查必要的字段是否存在
        if (!jsonData.time || !jsonData.filename) {
          throw new Error("JSON数据格式不正确，缺少必要字段");
        }
        
        // 检查JSON是否过期
        // 尝试解析时间字符串，支持多种格式
        let jsonTime;
        
        if (typeof jsonData.time === 'number') {
          // 如果时间已经是毫秒时间戳
          jsonTime = jsonData.time;
          console.log('检测到数字时间戳:', new Date(jsonTime));
        } else if (typeof jsonData.time === 'string') {
          // 处理 'YYYY-MM-DD HH:mm:ss' 格式
          const timeStr = jsonData.time;
          
          // 检查是否为 'YYYY-MM-DD HH:mm:ss' 格式
          if (/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}$/.test(timeStr)) {
            // 将 'YYYY-MM-DD HH:mm:ss' 分解为各部分
            const [datePart, timePart] = timeStr.split(' ');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hour, minute, second] = timePart.split(':').map(Number);
            
            // 创建日期对象（使用本地时区）
            const date = new Date(year, month - 1, day, hour, minute, second); // month是0索引
            jsonTime = date.getTime();
            console.log('解析日期时间格式 (YYYY-MM-DD HH:mm:ss):', timeStr, '结果:', new Date(jsonTime));
          } else {
            // 尝试解析ISO日期字符串或其他格式
            jsonTime = Date.parse(timeStr);
            console.log('解析字符串时间:', timeStr, '结果:', new Date(jsonTime));
            
            // 如果Date.parse失败，尝试其他常见格式
            if (isNaN(jsonTime)) {
              // 尝试作为秒级时间戳
              const timestamp = parseInt(timeStr);
              if (!isNaN(timestamp)) {
                jsonTime = timestamp * 1000; // 转换为毫秒
                console.log('转换为毫秒时间戳:', new Date(jsonTime));
              }
            }
          }
        }
        
        const now = Date.now();
        console.log('当前时间:', new Date(now));
        console.log('JSON时间:', new Date(jsonTime));
        
        // 验证时间戳是否有效
        if (isNaN(jsonTime)) {
          throw new Error("JSON中的时间格式无效");
        }
        
        const timeDiff = now - jsonTime;
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        console.log(`时间差: ${hoursDiff.toFixed(2)} 小时 (阈值: ${EXPIRE_DURATION/(1000*60*60)} 小时)`);
        
        const isAuthorized = timeDiff < EXPIRE_DURATION;
        console.log('授权状态:', isAuthorized ? '已授权' : '未授权');

        // 更新授权状态显示
        updateAuthStatus(isAuthorized);

        if (isAuthorized) {
          // 保存授权检查时间到本地存储
          localStorage.setItem(AUTH_CHECK_KEY, Date.now().toString());
          
          addToTerminal('授权验证成功，正在加载数据...');
          
          // 加载数据并更新界面
          await loadAndUpdateSoftware(jsonData);
          // 执行测速
          performSpeedTest(jsonData);
        } else {
          addToTerminal('授权验证失败，系统未授权');
        }
      } catch (error) {
        console.error('远程授权检查失败:', error);
        addToTerminal('授权检查失败: ' + error.message);
        
        // 尝试使用本地缓存的授权信息
        const lastAuthCheck = localStorage.getItem(AUTH_CHECK_KEY);
        if (lastAuthCheck) {
          const lastCheckTime = parseInt(lastAuthCheck);
          const now = Date.now();
          const timeDiff = now - lastCheckTime;
          
          if (timeDiff < LOCAL_AUTH_DURATION) {
            console.log('使用本地缓存的授权状态');
            addToTerminal('使用本地缓存的授权状态');
            updateAuthStatus(true);
            // 不执行后续的数据加载和测速，因为我们没有有效的远程数据
            return;
          }
        }
        
        // 远程检查失败且本地也没有有效缓存
        updateAuthStatus(false);
      }
    }

    // 更新授权状态显示（适配新的UI结构）
    function updateAuthStatus(isAuthorized) {
      const authContainer = document.getElementById('authContainer');
      const authTipBox = document.getElementById('authTipBox');
      const authTipText = document.getElementById('authTipText');
      const mainInterface = document.getElementById('mainInterface');

      if (isAuthorized) {
        // 授权成功
        authTipText.textContent = '授权成功 正在进入系统';
        authTipBox.classList.add('auth-tip-success'); // 切换为绿色背景
        
        // 抽拉进入系统的动画效果
        setTimeout(() => {
          // 首先让授权提示框向上滑出
          authTipBox.style.transition = 'transform 0.8s ease-in-out';
          authTipBox.style.transform = 'translateY(-100%)';
          
          // 稍微延迟后显示主界面
          setTimeout(() => {
            authContainer.classList.add('hidden');
            mainInterface.classList.remove('hidden');
            
            // 主界面淡入效果
            mainInterface.style.opacity = '0';
            mainInterface.style.transform = 'translateY(20px)';
            mainInterface.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
            
            // 触发动画
            setTimeout(() => {
              mainInterface.style.opacity = '1';
              mainInterface.style.transform = 'translateY(0)';
            }, 50);
          }, 600); // 等待授权框滑出后再切换界面
        }, 1000);
      } else {
        // 授权失败（恢复开始.html的样式）
        authTipText.textContent = '文件未授权请联系阿杰';
        authTipBox.classList.remove('auth-tip-success'); // 恢复红色背景
        
        // 显示授权失败界面
        authContainer.classList.remove('hidden', 'opacity-0');
        mainInterface.classList.add('hidden', 'opacity-0');
      }
    }

    // 加载并更新软件列表
    function loadAndUpdateSoftware(jsonData) {
      const newSoftware = {
        name: jsonData.filename.replace('.rar', ''),
        urls: {
          telcom: jsonData.telcom_url,
          unicom: jsonData.unicom_url,
          cmnet: jsonData.cmnet_url,
          usw: jsonData.usw_url
        }
      };

      // 检查是否是新软件
      const isNew = !currentSoftwareList.some(item => item.name === newSoftware.name);
      if (isNew) {
        currentSoftwareList.unshift(newSoftware); // 添加到列表顶部
        addToTerminal(`发现新软件: ${newSoftware.name}`);
        renderDownloadTable();
      } else {
        addToTerminal(`软件列表已是最新: ${newSoftware.name}`);
      }
    }

    // 渲染下载列表
    function renderDownloadTable(bestLineName = null) {
      const tableBody = document.getElementById('downloadTableBody');
      tableBody.innerHTML = '';

      currentSoftwareList.forEach((software, index) => {
        // 根据最佳线路确定按钮显示
        const telcomHtml = bestLineName === '电信' ? 
          `<a href="${software.urls.telcom}" class="download-btn best-download-btn"><i class="fa fa-download"></i>电信<span class="recommend-badge ml-1">推荐</span></a>` :
          `<a href="${software.urls.telcom}" class="download-btn"><i class="fa fa-download"></i>电信</a>`;
          
        const unicomHtml = bestLineName === '联通' ? 
          `<a href="${software.urls.unicom}" class="download-btn best-download-btn"><i class="fa fa-download"></i>联通<span class="recommend-badge ml-1">推荐</span></a>` :
          `<a href="${software.urls.unicom}" class="download-btn"><i class="fa fa-download"></i>联通</a>`;
          
        const cmnetHtml = bestLineName === '移动' ? 
          `<a href="${software.urls.cmnet}" class="download-btn best-download-btn"><i class="fa fa-download"></i>移动<span class="recommend-badge ml-1">推荐</span></a>` :
          `<a href="${software.urls.cmnet}" class="download-btn"><i class="fa fa-download"></i>移动</a>`;
          
        const uswHtml = bestLineName === '北美' ? 
          `<a href="${software.urls.usw}" class="download-btn best-download-btn"><i class="fa fa-download"></i>北美<span class="recommend-badge ml-1">推荐</span></a>` :
          `<a href="${software.urls.usw}" class="download-btn"><i class="fa fa-download"></i>北美</a>`;
        
        // 为每一行分配不同的背景色
        const rowColors = [
          'bg-blue-500/10',
          'bg-green-500/10',
          'bg-purple-500/10',
          'bg-yellow-500/10',
          'bg-pink-500/10',
          'bg-indigo-500/10'
        ];
        
        const rowColor = rowColors[index % rowColors.length];
        
        const row = document.createElement('tr');
        row.className = `border-b border-dark/50 hover:bg-primary/10 transition-colors ${rowColor}`;
        
        row.innerHTML = `
          <td class="p-2 font-cyber">${software.name}</td>
          <td class="p-1 text-center" colspan="4">
            <div class="download-container">
              ${telcomHtml}
              ${unicomHtml}
              ${cmnetHtml}
              ${uswHtml}
            </div>
          </td>
        `;

        tableBody.appendChild(row);
      });
      
      addToTerminal(`已渲染 ${currentSoftwareList.length} 个软件的下载链接`);
    }

    // 执行多线路延迟测试
    async function performSpeedTest(jsonData) {
      addToTerminal('开始网络延迟测试...');
      
      const urls = [
        { id: 'telcomSpeed', url: jsonData.telcom_url, name: '电信' },
        { id: 'unicomSpeed', url: jsonData.unicom_url, name: '联通' },
        { id: 'cmnetSpeed', url: jsonData.cmnet_url, name: '移动' },
        { id: 'uswSpeed', url: jsonData.usw_url, name: '北美' }
      ];

      let delayResults = [];
      for (const item of urls) {
        addToTerminal(`正在测试${item.name}线路延迟...`);
        const delay = await testConnectionDelay(item.url);
        delayResults.push({
          id: item.id,
          name: item.name,
          delay: delay,
          url: item.url
        });
      }
      
      // 找到延迟最低的线路
      delayResults.sort((a, b) => a.delay - b.delay);
      const best = delayResults[0];
      
      // 显示所有线路的延迟
      for (const result of delayResults) {
        const element = document.getElementById(result.id);
        if (result.delay > 0) {
          element.textContent = `${result.delay} ms`;
          addToTerminal(`${result.name}线路延迟: ${result.delay} ms`);
          // 如果是最佳线路，可以添加特殊标识
          if (result.delay === best.delay) {
            element.parentElement.classList.add('best-line');
            setTimeout(() => {
              element.parentElement.classList.remove('best-line');
            }, 3000); // 3秒后移除高亮
          }
        } else {
          element.textContent = '超时';
          addToTerminal(`${result.name}线路测试超时`);
        }
      }
      
      // 在平均速度区域显示最佳线路
      if (best.delay > 0) {
        document.getElementById('avgSpeed').textContent = `最佳: ${best.name} ${best.delay} ms`;
        addToTerminal(`推荐使用${best.name}线路 (${best.delay} ms)，延迟最低`);
        
        // 更新下载按钮，标记最佳线路
        renderDownloadTable(best.name);
      } else {
        document.getElementById('avgSpeed').textContent = '全部超时';
        addToTerminal('所有线路测试均超时');
        
        // 如果没有最佳线路，重新渲染按钮（移除推荐标记）
        renderDownloadTable();
      }
      
      // 在控制台输出完整的延迟结果
      console.log('完整延迟测试结果:', delayResults);
    }

    // 测试连接延迟（毫秒）
    async function testConnectionDelay(url) {
      try {
        const startTime = performance.now();
        
        // 发送一个简单的HEAD请求来测试延迟
        const response = await fetch(url, { 
          method: 'HEAD',
          cache: 'no-cache'
        });
        
        const endTime = performance.now();
        const delay = Math.round(endTime - startTime);
        
        // 如果请求成功，返回延迟时间
        if (response.ok) {
          return delay;
        } else {
          // 如果响应不成功，返回超时
          return 0;
        }
      } catch (error) {
        console.error('延迟测试失败:', error);
        return 0; // 表示超时或错误
      }
    }
    
    // 单线路测速 - 改进版本（保留原功能，以防需要）
    async function testSingleLineSpeed(url) {
      try {
        // 使用一个较小的测试文件进行测速，避免下载整个大文件
        const testUrl = url.includes('?') ? url + '&test=1' : url + '?test=1';
        
        const startTime = performance.now();
        // 尝试获取Content-Length头部信息
        const headResponse = await fetch(testUrl, { method: 'HEAD' });
        
        if (!headResponse.ok) {
          return 0;
        }
        
        const fileSize = parseInt(headResponse.headers.get('Content-Length')) || 0;
        
        // 如果无法获取文件大小，则使用实际下载一小段时间的方法
        if (fileSize === 0) {
          // 只下载前1MB的数据来估算速度
          const partialResponse = await fetch(testUrl, { 
            headers: {
              'Range': 'bytes=0-1048575' // 请求前1MB
            }
          });
          
          if (!partialResponse.ok && partialResponse.status !== 206) {
            return 0;
          }
          
          const partialData = await partialResponse.arrayBuffer();
          const endTime = performance.当前();
          const duration = (endTime - startTime) / 1000; // 转换为秒
          
          // 计算速度（Mbps）
          const speed = (partialData.byteLength * 8) / (1024 * 1024 * duration);
          return speed;
        } else {
          // 如果有文件大小信息，通过HEAD请求时间估算速度
          const endTime = performance.当前();
          const duration = (endTime - startTime) / 1000; // 转换为秒
          
          // 计算速度（Mbps）
          const speed = (fileSize * 8) / (1024 * 1024 * duration);
          return speed;
        }
      } catch (error) {
        console.error('测速失败:', error);
        return 0;
      }
    }
    // 添加终端日志消息
    function addToTerminal(message) {
      const terminalOutput = document.getElementById('terminalOutput');
      const lineElement = document.createElement('div');
      lineElement.className = 'terminal-line';
      lineElement.textContent = `> ${message}`;
      terminalOutput.appendChild(lineElement);
      
      // 自动滚动到底部
      terminalOutput.scrollTop = terminalOutput.scrollHeight;
      
      // 限制日志数量，最多保留50行
      if (terminalOutput.children.length > 50) {
        terminalOutput.removeChild(terminalOutput.firstChild);
      }
    }
    
    // 模拟一些系统活动日志
    function simulateSystemActivity() {
      const activities = [
        '检查系统完整性...',
        '验证授权状态...',
        '同步配置文件...',
        '更新软件列表...',
        '网络质量监控中...',
        '安全扫描完成',
        '系统资源充足',
        '准备就绪，等待用户操作...'
      ];
      
      // 随机选择一个活动添加到日志
      const randomActivity = activities[Math.floor(Math.random() * activities.length)];
      addToTerminal(randomActivity);
    }
    
    // 定期添加模拟活动
    setInterval(simulateSystemActivity, 15000); // 每15秒添加一条模拟日志
  </script>
</body>
</html>
